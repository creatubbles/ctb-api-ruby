#!/usr/bin/env ruby

$:.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'optparse'
require 'creatubbles'

auth_details = {
  client_id: ENV['CREATUBBLES_CLIENT_ID'],
  client_secret: ENV['CREATUBBLES_CLIENT_SECRET'],
  api_url: ENV['CREATUBBLES_API_URL'] || Creatubbles::DEFAULT_API_URL,
  username: ENV['CREATUBBLES_USERNAME'],
  password: ENV['CREATUBBLES_PASSWORD']
}

creation_details = {}
galleries = []

opt_parser = OptionParser.new do |opt|
  opt.banner = "Usage: ctb_uploader <file> [OPTIONS]"
  opt.separator  ""
  opt.separator  "file"
  opt.separator  "     path to file you'd like to upload; has to be a supported file type"
  opt.separator  ""
  opt.separator  "Environment"
  opt.separator  "     CREATUBBLES_CLIENT_ID: application client ID"
  opt.separator  "     CREATUBBLES_CLIENT_SECRET: application client secret"
  opt.separator  "     CREATUBBLES_USERNAME: user's email"
  opt.separator  "     CREATUBBLES_PASSWORD: user's password"
  opt.separator  "     CREATUBBLES_API_URL: API URL (default: #{Creatubbles::DEFAULT_API_URL})"
  opt.separator  ""
  opt.separator  "Options"

  opt.on("-u","--username EMAIL","user's email") do |email|
    auth_details[:username] = email
  end
  opt.on("-p","--password password","user's password") do |password|
    auth_details[:password] = password
  end

  opt.on("-n","--name NAME","creation name") do |name|
    creation_details[:name] = name
  end
  opt.on("-d","--description TEXT","description text") do |text|
    creation_details[:description] = text
  end

  opt.on("-g","--gallery GALLERY_ID","add creation to gallery") do |gallery_id|
    galleries << gallery_id
  end

  opt.on("-h","--help","help") do
    puts opt_parser
  end
end

opt_parser.parse!

if (file=ARGV[0])
  client = Creatubbles::Client.new(auth_details)
  creation = client.creations.create(creation_details)
  puts "created creation #{creation.id}"
  creation.upload(file)
  puts " - uploaded #{file}"
  galleries.each do |gallery_id|
    gallery = client.galleries.find(gallery_id)
    gallery.add_creation(creation)
    puts " - added to gallery #{gallery_id}"
  end
  puts "done."
else
  puts opt_parser
end
